<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Virtual Computational Biologist</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  </head>
  <body>
    <main class="container">
      {% set has_search = geo_search_items|length > 0 %}
      {% set has_loaded = geo_loaded_summary.returned > 0 %}
      {% set has_analysis = analysis and analysis.metadata.n_genes > 0 %}
      <header>
        <div>
          <h1>Virtual Computational Biologist</h1>
          <p>Run the workflow in order: search GEO, load datasets, then run comparison analysis.</p>
        </div>
      </header>

      <section class="workflow-rail">
        <article class="workflow-step {% if has_search %}is-complete{% endif %}">
          <p class="workflow-kicker">Step 1</p>
          <h3>Search GEO</h3>
          <p>{% if has_search %}Datasets found{% else %}Choose filters and run search{% endif %}</p>
        </article>
        <article class="workflow-step {% if has_loaded %}is-complete{% endif %}">
          <p class="workflow-kicker">Step 2</p>
          <h3>Load Datasets</h3>
          <p>{% if has_loaded %}{{ geo_loaded_summary.returned }} loaded{% else %}Select rows and load{% endif %}</p>
        </article>
        <article class="workflow-step {% if has_analysis %}is-complete{% endif %}">
          <p class="workflow-kicker">Step 3</p>
          <h3>Run Analysis</h3>
          <p>{% if has_analysis %}Results ready{% else %}Configure and run comparison{% endif %}</p>
        </article>
      </section>

      <section class="panel step-panel" id="geo-search-section">
        <div class="step-head">
          <span class="step-index">1</span>
          <div>
            <h2>GEO Search</h2>
            <p class="step-sub">Find candidate studies before loading them for analysis.</p>
          </div>
        </div>
        <form action="{{ url_for('geo_search') }}" method="post" class="inline-form" data-preserve-scroll="true">
          <label>
            Query
            <input type="text" name="query" value="{{ geo_search_summary.query or geo_default_query }}" />
          </label>
          <label>
            Species
            <input type="text" name="species" placeholder="e.g. Homo sapiens" value="{{ geo_search_summary.species_filter }}" />
          </label>
          <label>
            Experiment Type
            <select name="experiment_type">
              {% for exp_type in experiment_type_options %}
                <option value="{{ exp_type }}" {% if exp_type == geo_search_summary.experiment_filter %}selected{% endif %}>{{ exp_type }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            State Filter
            <select name="state_filter">
              {% for state_option in state_filter_options %}
                <option value="{{ state_option }}" {% if state_option == geo_search_summary.state_filter %}selected{% endif %}>{{ state_option }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Count
            <input type="number" name="retmax" min="1" max="100" value="{{ geo_search_summary.requested_retmax or geo_default_fetch_size }}" />
          </label>
          <label class="inline-check">
            <input type="checkbox" name="only_analyzable" {% if geo_search_summary.only_analyzable %}checked{% endif %} />
            Only analyzable datasets
          </label>
          <button type="submit" class="run-btn">Run Step 1 Search</button>
        </form>

        <p class="note">
          Source: {{ geo_search_summary.source }} | Query: {{ geo_search_summary.query or "none" }} |
          Returned: {{ geo_search_summary.returned }}{% if geo_search_summary.only_analyzable %} (from {{ geo_search_summary.returned_before_analyzable_filter }} prefiltered){% endif %} |
          Total found: {{ geo_search_summary.total_found }}
        </p>
        {% if geo_search_summary.source.endswith("_error") %}
          <p class="note">GEO metadata search failed. Check local SQLite/API setup and rerun search.</p>
          {% if geo_search_summary.error %}
            <p class="note">Error detail: {{ geo_search_summary.error }}</p>
          {% endif %}
        {% endif %}

        {% if geo_search_items %}
          <form action="{{ url_for('geo_load_selected') }}" method="post" data-preserve-scroll="true">
            <div class="table-action">
              <button type="submit" class="run-btn">Run Step 2 Load Selected</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Select</th>
                  <th>Accession</th>
                  <th>Title</th>
                  <th>Species</th>
                  <th>Experiment</th>
                  <th>State</th>
                  <th>Analyzable</th>
                  <th>Samples</th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody>
                {% for row in geo_search_items %}
                  {% set dataset_id = row.accession or row.uid %}
                  <tr>
                    <td><input type="checkbox" name="selected_ids" value="{{ dataset_id }}" {% if not row.analyzable %}disabled{% endif %} /></td>
                    <td>
                      {% if row.geo_link %}
                        <a href="{{ row.geo_link }}" target="_blank" rel="noopener noreferrer">{{ dataset_id }}</a>
                      {% else %}
                        {{ dataset_id }}
                      {% endif %}
                    </td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.organism }}</td>
                    <td>{{ row.experiment_type }}</td>
                    <td>{{ row.state_profile }}</td>
                    <td title="{{ row.analyzable_detail }}">{% if row.analyzable %}Yes{% else %}No{% endif %}</td>
                    <td>{{ row.n_samples }}</td>
                    <td class="link-list">
                      {% if row.geo_link %}
                        <a href="{{ row.geo_link }}" target="_blank" rel="noopener noreferrer">GEO</a>
                      {% endif %}
                      {% if row.pubmed_link %}
                        <a href="{{ row.pubmed_link }}" target="_blank" rel="noopener noreferrer">PubMed</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
          <p class="note">Only rows marked analyzable are selectable for loading into real DE analysis.</p>
        {% else %}
          <p class="note">No GEO search results yet. Run a GEO search first.</p>
        {% endif %}
      </section>

      <section class="panel step-panel" id="loaded-section">
        <div class="step-head">
          <span class="step-index">2</span>
          <div>
            <h2>Loaded Datasets</h2>
            <p class="step-sub">Review the selected studies before differential expression analysis.</p>
          </div>
        </div>
        <p class="note">
          Loaded: {{ geo_loaded_summary.returned }} | Query: {{ geo_loaded_summary.query or "none" }} |
          State filter: {{ geo_loaded_summary.state_filter }}
        </p>

        {% if geo_loaded_items %}
          <table>
            <thead>
              <tr>
                <th>Accession</th>
                <th>Title</th>
                <th>Species</th>
                <th>Experiment</th>
                <th>State</th>
                <th>Samples</th>
              </tr>
            </thead>
            <tbody>
              {% for row in geo_loaded_items %}
                <tr>
                  <td>
                    {% set loaded_id = row.accession or row.uid %}
                    {% if row.geo_link %}
                      <a href="{{ row.geo_link }}" target="_blank" rel="noopener noreferrer">{{ loaded_id }}</a>
                    {% else %}
                      {{ loaded_id }}
                    {% endif %}
                  </td>
                  <td>{{ row.title }}</td>
                  <td>{{ row.organism }}</td>
                  <td>{{ row.experiment_type }}</td>
                  <td>{{ row.state_profile }}</td>
                  <td>{{ row.n_samples }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="note">Select rows from GEO search and click "Run Step 2 Load Selected".</p>
        {% endif %}
      </section>

      <section class="panel step-panel" id="analysis-section">
        <div class="step-head">
          <span class="step-index">3</span>
          <div>
            <h2>State Comparison Analysis</h2>
            <p class="step-sub">Configure thresholds and run differential expression with enrichment.</p>
          </div>
        </div>
        <form action="{{ url_for('run_analysis') }}" method="post" class="inline-form" data-preserve-scroll="true">
          <label>
            Comparison State
            <select name="analysis_state">
              {% for state_option in state_filter_options %}
                {% if state_option != 'All' %}
                  <option value="{{ state_option }}" {% if analysis and analysis.metadata.state_profile == state_option %}selected{% endif %}>{{ state_option }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </label>
          <label>
            padj cutoff
            <input type="text" inputmode="decimal" name="padj_cutoff" value="{{ analysis.metadata.padj_cutoff if analysis else '0.05' }}" />
          </label>
          <label>
            |log2FC| cutoff
            <input type="text" inputmode="decimal" name="log2fc_cutoff" value="{{ analysis.metadata.log2fc_cutoff if analysis else '1.0' }}" />
          </label>
          <label>
            Enrichment
            {% set current_enrichment_mode = analysis.metadata.enrichment_mode if analysis and analysis.metadata.enrichment_mode else 'auto' %}
            <select name="enrichment_mode">
              {% for mode in enrichment_mode_options %}
                <option value="{{ mode }}" {% if mode == current_enrichment_mode %}selected{% endif %}>
                  {% if mode == 'auto' %}Auto (g:Profiler -> local){% elif mode == 'gprofiler' %}g:Profiler only{% elif mode == 'local' %}Local pathways only{% else %}{{ mode }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <button type="submit" class="run-btn" {% if geo_loaded_summary.returned == 0 %}disabled{% endif %}>Run Step 3 Analysis</button>
        </form>

        {% if analysis %}
          <p class="note">
            Mode: {{ analysis.metadata.mode }} | Enrichment: {{ analysis.metadata.enrichment_mode if analysis.metadata.enrichment_mode else 'auto' }}{% if analysis.metadata.real_dataset_used %} | GEO matrix: {{ analysis.metadata.real_dataset_used }}{% endif %}{% if analysis.metadata.group_a_n and analysis.metadata.group_b_n %} | {{ analysis.metadata.group_a_name }} n={{ analysis.metadata.group_a_n }}, {{ analysis.metadata.group_b_name }} n={{ analysis.metadata.group_b_n }}{% endif %}
          </p>
          {% if analysis.metadata.notes %}
            <p class="note">{{ analysis.metadata.notes|join(' ; ') }}</p>
          {% endif %}
          {% if analysis.metadata.mode == "needs_group_selection" and analysis.group_choice %}
            <h3>Manual Group Selection Required</h3>
            <form action="{{ url_for('run_analysis_manual') }}" method="post" class="panel" data-preserve-scroll="true">
              <input type="hidden" name="analysis_state" value="{{ analysis.metadata.state_profile }}" />
              <input type="hidden" name="padj_cutoff" value="{{ analysis.metadata.padj_cutoff }}" />
              <input type="hidden" name="log2fc_cutoff" value="{{ analysis.metadata.log2fc_cutoff }}" />
              <input type="hidden" name="enrichment_mode" value="{{ analysis.metadata.enrichment_mode if analysis.metadata.enrichment_mode else 'auto' }}" />
              <input type="hidden" name="manual_gse" value="{{ analysis.group_choice.gse }}" />

              <p class="note">Dataset: {{ analysis.group_choice.gse }} | Source: {{ analysis.group_choice.source }}</p>

              <div class="inline-form">
                <label>
                  Group A Name
                  <input type="text" name="group_a_name" value="{{ analysis.group_choice.group_a_name }}" />
                </label>
                <label>
                  Group B Name
                  <input type="text" name="group_b_name" value="{{ analysis.group_choice.group_b_name }}" />
                </label>
              </div>

              <h4>Sample Assignment</h4>
              <p class="note">Assign each sample to Group A, Group B, or Exclude. At least 2 samples are required in each analysis group.</p>
              <table>
                <thead>
                  <tr>
                    <th>Sample ID</th>
                    <th>Assign</th>
                    <th>Suggested Group</th>
                    <th>Annotation</th>
                  </tr>
                </thead>
                <tbody>
                  {% for opt in analysis.group_choice.sample_options %}
                    {% set suggested = 'Exclude' %}
                    {% if opt.id in analysis.group_choice.suggested_group_a %}
                      {% set suggested = analysis.group_choice.group_a_name %}
                    {% elif opt.id in analysis.group_choice.suggested_group_b %}
                      {% set suggested = analysis.group_choice.group_b_name %}
                    {% endif %}
                    {% set default_code = 'X' %}
                    {% if opt.id in analysis.group_choice.suggested_group_a %}
                      {% set default_code = 'A' %}
                    {% elif opt.id in analysis.group_choice.suggested_group_b %}
                      {% set default_code = 'B' %}
                    {% endif %}
                    <tr>
                      <td class="sample-id-cell">
                        {{ opt.id }}
                        <input type="hidden" name="sample_ids" value="{{ opt.id }}" />
                      </td>
                      <td>
                        <select name="sample_groups" class="sample-group-select">
                          <option value="A" {% if default_code == 'A' %}selected{% endif %}>{{ analysis.group_choice.group_a_name }}</option>
                          <option value="B" {% if default_code == 'B' %}selected{% endif %}>{{ analysis.group_choice.group_b_name }}</option>
                          <option value="X" {% if default_code == 'X' %}selected{% endif %}>Exclude</option>
                        </select>
                      </td>
                      <td>
                        {{ suggested }}
                      </td>
                      <td class="sample-annotation">{{ opt.label }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

              <div class="table-action">
                <button type="submit" class="run-btn">Run Analysis With Selected Groups</button>
              </div>
            </form>
          {% elif analysis.metadata.mode == "no_usable_matrix_data" %}
            <h3>Real Analysis Blocked</h3>
            <p class="note">
              The selected dataset does not expose a usable expression matrix for this pipeline.
              Load a different GSE (with tabular expression/count matrix files) and rerun analysis.
            </p>
          {% elif analysis.metadata.mode == "missing_dependency" %}
            <h3>Real Analysis Blocked</h3>
            <p class="note">
              DESeq2 analysis requires the `pydeseq2` package in your environment.
              Install dependencies and rerun analysis.
            </p>
          {% elif analysis.metadata.n_genes > 0 %}
            <section class="cards">
              <article class="card"><h2>Datasets</h2><p>{{ analysis.metadata.n_datasets }}</p></article>
              <article class="card"><h2>Genes</h2><p>{{ analysis.metadata.n_genes }}</p></article>
              <article class="card"><h2>Upregulated</h2><p>{{ analysis.metadata.n_up }}</p></article>
              <article class="card"><h2>Downregulated</h2><p>{{ analysis.metadata.n_down }}</p></article>
            </section>

            <h3>Volcano Plot</h3>
            <div id="volcano-plot" class="volcano"></div>

            <div class="two-col">
              <div>
                <h3>Top Upregulated Genes</h3>
                <table>
                  <thead><tr><th>Gene</th><th>log2FC</th><th>padj</th></tr></thead>
                  <tbody>
                    {% for row in analysis.top_up %}
                      <tr>
                        <td>
                          {% if row.gene_url %}
                            <a href="{{ row.gene_url }}" target="_blank" rel="noopener noreferrer">{{ row.gene }}</a>
                          {% else %}
                            {{ row.gene }}
                          {% endif %}
                        </td>
                        <td>{{ '%.2f'|format(row.log2fc) }}</td>
                        <td>{{ '%.3g'|format(row.padj) }}</td>
                      </tr>
                    {% endfor %}
                    {% if not analysis.top_up %}
                      <tr><td colspan="3" class="note">No genes passed thresholds.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <div>
                <h3>Top Downregulated Genes</h3>
                <table>
                  <thead><tr><th>Gene</th><th>log2FC</th><th>padj</th></tr></thead>
                  <tbody>
                    {% for row in analysis.top_down %}
                      <tr>
                        <td>
                          {% if row.gene_url %}
                            <a href="{{ row.gene_url }}" target="_blank" rel="noopener noreferrer">{{ row.gene }}</a>
                          {% else %}
                            {{ row.gene }}
                          {% endif %}
                        </td>
                        <td>{{ '%.2f'|format(row.log2fc) }}</td>
                        <td>{{ '%.3g'|format(row.padj) }}</td>
                      </tr>
                    {% endfor %}
                    {% if not analysis.top_down %}
                      <tr><td colspan="3" class="note">No genes passed thresholds.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="two-col">
              <div>
                <h3>Enrichment (Up)</h3>
                <table>
                  <thead><tr><th>Pathway</th><th>Overlap</th><th>padj</th></tr></thead>
                  <tbody>
                    {% for row in analysis.enrichment_up %}
                      <tr>
                        <td>
                          {% if row.pathway_url %}
                            <a href="{{ row.pathway_url }}" target="_blank" rel="noopener noreferrer">{{ row.pathway }}</a>
                          {% else %}
                            {{ row.pathway }}
                          {% endif %}
                        </td>
                        <td>{{ row.overlap }}/{{ row.set_size }}</td>
                        <td>{{ '%.3g'|format(row.padj) }}</td>
                      </tr>
                    {% endfor %}
                    {% if not analysis.enrichment_up %}
                      <tr><td colspan="3" class="note">No enriched pathways at current thresholds.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <div>
                <h3>Enrichment (Down)</h3>
                <table>
                  <thead><tr><th>Pathway</th><th>Overlap</th><th>padj</th></tr></thead>
                  <tbody>
                    {% for row in analysis.enrichment_down %}
                      <tr>
                        <td>
                          {% if row.pathway_url %}
                            <a href="{{ row.pathway_url }}" target="_blank" rel="noopener noreferrer">{{ row.pathway }}</a>
                          {% else %}
                            {{ row.pathway }}
                          {% endif %}
                        </td>
                        <td>{{ row.overlap }}/{{ row.set_size }}</td>
                        <td>{{ '%.3g'|format(row.padj) }}</td>
                      </tr>
                    {% endfor %}
                    {% if not analysis.enrichment_down %}
                      <tr><td colspan="3" class="note">No enriched pathways at current thresholds.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          {% else %}
            <p class="note">No real-analysis results yet.</p>
          {% endif %}
        {% else %}
          <p class="note">Run analysis after loading datasets to generate volcano and enrichment outputs.</p>
        {% endif %}
      </section>

      <footer>
        <p>Protein refresh metadata: {{ protein_metadata.data_source }} | {{ protein_metadata.last_updated_utc }}</p>
      </footer>
    </main>
    <script>
      (() => {
        const key = "scrollYBeforePost";
        const pending = window.sessionStorage.getItem(key);
        if (pending) {
          const y = parseInt(pending, 10);
          if (!Number.isNaN(y)) {
            window.scrollTo(0, y);
          }
          window.sessionStorage.removeItem(key);
        }

        document.querySelectorAll("form[data-preserve-scroll='true']").forEach((form) => {
          form.addEventListener("submit", () => {
            window.sessionStorage.setItem(key, String(window.scrollY));
          });
        });
      })();
    </script>
    {% if analysis and analysis.metadata.n_genes > 0 %}
      <script>
        (() => {
          const points = {{ analysis.volcano.points | tojson }};
          const groups = {
            "Upregulated": { x: [], y: [], text: [], color: "#c0392b" },
            "Downregulated": { x: [], y: [], text: [], color: "#1f78b4" },
            "Not Significant": { x: [], y: [], text: [], color: "#8c9a91" },
          };

          for (const p of points) {
            const g = groups[p.group] || groups["Not Significant"];
            g.x.push(p.x);
            g.y.push(p.y);
            g.text.push(`${p.gene}<br>log2FC=${p.x.toFixed(3)}<br>-log10(padj)=${p.y.toFixed(3)}`);
          }

          const traces = Object.entries(groups).map(([name, g]) => ({
            x: g.x,
            y: g.y,
            text: g.text,
            mode: "markers",
            type: "scattergl",
            name,
            hovertemplate: "%{text}<extra></extra>",
            marker: { size: 6, color: g.color, opacity: 0.8 }
          }));

          const layout = {
            margin: { l: 50, r: 20, t: 20, b: 50 },
            paper_bgcolor: "#fbfdfb",
            plot_bgcolor: "#fbfdfb",
            xaxis: { title: "log2 Fold Change", zeroline: true, zerolinecolor: "#4d5a52" },
            yaxis: { title: "-log10 adjusted p-value", zeroline: false },
            legend: { orientation: "h", y: 1.1 }
          };

          Plotly.newPlot("volcano-plot", traces, layout, { responsive: true, displaylogo: false });
        })();
      </script>
    {% endif %}
  </body>
</html>

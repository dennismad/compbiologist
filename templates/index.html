<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Virtual Computational Biologist</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>Virtual Computational Biologist</h1>
        <p>State comparison workflow with GEO search, dataset selection, enrichment, and volcano visualization.</p>
      </header>

      <section class="panel">
        <h2>1) GEO Search</h2>
        <form action="{{ url_for('geo_search') }}" method="post" class="inline-form">
          <label>
            Query
            <input type="text" name="query" value="{{ geo_search_summary.query or geo_default_query }}" />
          </label>
          <label>
            Species
            <input type="text" name="species" placeholder="e.g. Homo sapiens" value="{{ geo_search_summary.species_filter }}" />
          </label>
          <label>
            Experiment Type
            <select name="experiment_type">
              {% for exp_type in experiment_type_options %}
                <option value="{{ exp_type }}" {% if exp_type == geo_search_summary.experiment_filter %}selected{% endif %}>{{ exp_type }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            State Filter
            <select name="state_filter">
              {% for state_option in state_filter_options %}
                <option value="{{ state_option }}" {% if state_option == geo_search_summary.state_filter %}selected{% endif %}>{{ state_option }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Count
            <input type="number" name="retmax" min="1" max="100" value="{{ geo_default_fetch_size }}" />
          </label>
          <button type="submit">Search GEO</button>
        </form>

        <p class="note">
          Source: {{ geo_search_summary.source }} | Query: {{ geo_search_summary.query or "none" }} |
          Returned: {{ geo_search_summary.returned }} | Total found: {{ geo_search_summary.total_found }}
        </p>

        {% if geo_search_items %}
          <form action="{{ url_for('geo_load_selected') }}" method="post">
            <div class="table-action">
              <button type="submit">Load Selected Datasets</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Select</th>
                  <th>Accession</th>
                  <th>Title</th>
                  <th>Species</th>
                  <th>Experiment</th>
                  <th>State</th>
                  <th>Samples</th>
                  <th>Links</th>
                </tr>
              </thead>
              <tbody>
                {% for row in geo_search_items %}
                  {% set dataset_id = row.accession or row.uid %}
                  <tr>
                    <td><input type="checkbox" name="selected_ids" value="{{ dataset_id }}" /></td>
                    <td>{{ dataset_id }}</td>
                    <td>{{ row.title }}</td>
                    <td>{{ row.organism }}</td>
                    <td>{{ row.experiment_type }}</td>
                    <td>{{ row.state_profile }}</td>
                    <td>{{ row.n_samples }}</td>
                    <td class="link-list">
                      {% if row.geo_link %}
                        <a href="{{ row.geo_link }}" target="_blank" rel="noopener noreferrer">GEO</a>
                      {% endif %}
                      {% if row.pubmed_link %}
                        <a href="{{ row.pubmed_link }}" target="_blank" rel="noopener noreferrer">PubMed</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
        {% else %}
          <p class="note">No GEO search results yet. Run a GEO search first.</p>
        {% endif %}
      </section>

      <section class="panel">
        <h2>2) Loaded Datasets</h2>
        <p class="note">
          Loaded: {{ geo_loaded_summary.returned }} | Query: {{ geo_loaded_summary.query or "none" }} |
          State filter: {{ geo_loaded_summary.state_filter }}
        </p>

        {% if geo_loaded_items %}
          <table>
            <thead>
              <tr>
                <th>Accession</th>
                <th>Title</th>
                <th>Species</th>
                <th>Experiment</th>
                <th>State</th>
                <th>Samples</th>
              </tr>
            </thead>
            <tbody>
              {% for row in geo_loaded_items %}
                <tr>
                  <td>{{ row.accession or row.uid }}</td>
                  <td>{{ row.title }}</td>
                  <td>{{ row.organism }}</td>
                  <td>{{ row.experiment_type }}</td>
                  <td>{{ row.state_profile }}</td>
                  <td>{{ row.n_samples }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="note">Select rows from GEO search and click "Load Selected Datasets".</p>
        {% endif %}
      </section>

      <section class="panel">
        <h2>3) State Comparison Analysis</h2>
        <form action="{{ url_for('run_analysis') }}" method="post" class="inline-form">
          <label>
            Comparison State
            <select name="analysis_state">
              {% for state_option in state_filter_options %}
                {% if state_option != 'All' %}
                  <option value="{{ state_option }}" {% if analysis and analysis.metadata.state_profile == state_option %}selected{% endif %}>{{ state_option }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </label>
          <label>
            padj cutoff
            <input type="text" inputmode="decimal" name="padj_cutoff" value="{{ analysis.metadata.padj_cutoff if analysis else '0.05' }}" />
          </label>
          <label>
            |log2FC| cutoff
            <input type="text" inputmode="decimal" name="log2fc_cutoff" value="{{ analysis.metadata.log2fc_cutoff if analysis else '1.0' }}" />
          </label>
          <button type="submit" {% if geo_loaded_summary.returned == 0 %}disabled{% endif %}>Run Analysis</button>
        </form>

        {% if analysis %}
          <p class="note">
            Mode: {{ analysis.metadata.mode }}{% if analysis.metadata.real_dataset_used %} | GEO matrix: {{ analysis.metadata.real_dataset_used }}{% endif %}{% if analysis.metadata.group_a_n and analysis.metadata.group_b_n %} | {{ analysis.metadata.group_a_name }} n={{ analysis.metadata.group_a_n }}, {{ analysis.metadata.group_b_name }} n={{ analysis.metadata.group_b_n }}{% endif %}
          </p>
          {% if analysis.metadata.notes %}
            <p class="note">{{ analysis.metadata.notes|join(' ; ') }}</p>
          {% endif %}

          <section class="cards">
            <article class="card"><h2>Datasets</h2><p>{{ analysis.metadata.n_datasets }}</p></article>
            <article class="card"><h2>Genes</h2><p>{{ analysis.metadata.n_genes }}</p></article>
            <article class="card"><h2>Upregulated</h2><p>{{ analysis.metadata.n_up }}</p></article>
            <article class="card"><h2>Downregulated</h2><p>{{ analysis.metadata.n_down }}</p></article>
          </section>

          <h3>Volcano Plot</h3>
          <div id="volcano-plot" class="volcano"></div>

          <div class="two-col">
            <div>
              <h3>Top Upregulated Genes</h3>
              <table>
                <thead><tr><th>Gene</th><th>log2FC</th><th>padj</th></tr></thead>
                <tbody>
                  {% for row in analysis.top_up %}
                    <tr><td>{{ row.gene }}</td><td>{{ '%.2f'|format(row.log2fc) }}</td><td>{{ '%.3g'|format(row.padj) }}</td></tr>
                  {% endfor %}
                  {% if not analysis.top_up %}
                    <tr><td colspan="3" class="note">No genes passed thresholds.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            <div>
              <h3>Top Downregulated Genes</h3>
              <table>
                <thead><tr><th>Gene</th><th>log2FC</th><th>padj</th></tr></thead>
                <tbody>
                  {% for row in analysis.top_down %}
                    <tr><td>{{ row.gene }}</td><td>{{ '%.2f'|format(row.log2fc) }}</td><td>{{ '%.3g'|format(row.padj) }}</td></tr>
                  {% endfor %}
                  {% if not analysis.top_down %}
                    <tr><td colspan="3" class="note">No genes passed thresholds.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="two-col">
            <div>
              <h3>Enrichment (Up)</h3>
              <table>
                <thead><tr><th>Pathway</th><th>Overlap</th><th>padj</th></tr></thead>
                <tbody>
                  {% for row in analysis.enrichment_up %}
                    <tr><td>{{ row.pathway }}</td><td>{{ row.overlap }}/{{ row.set_size }}</td><td>{{ '%.3g'|format(row.padj) }}</td></tr>
                  {% endfor %}
                  {% if not analysis.enrichment_up %}
                    <tr><td colspan="3" class="note">No enriched pathways at current thresholds.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            <div>
              <h3>Enrichment (Down)</h3>
              <table>
                <thead><tr><th>Pathway</th><th>Overlap</th><th>padj</th></tr></thead>
                <tbody>
                  {% for row in analysis.enrichment_down %}
                    <tr><td>{{ row.pathway }}</td><td>{{ row.overlap }}/{{ row.set_size }}</td><td>{{ '%.3g'|format(row.padj) }}</td></tr>
                  {% endfor %}
                  {% if not analysis.enrichment_down %}
                    <tr><td colspan="3" class="note">No enriched pathways at current thresholds.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        {% else %}
          <p class="note">Run analysis after loading datasets to generate volcano and enrichment outputs.</p>
        {% endif %}
      </section>

      <footer>
        <p>Protein refresh metadata: {{ protein_metadata.data_source }} | {{ protein_metadata.last_updated_utc }}</p>
      </footer>
    </main>
    {% if analysis %}
      <script>
        (() => {
          const points = {{ analysis.volcano.points | tojson }};
          const groups = {
            "Upregulated": { x: [], y: [], text: [], color: "#c0392b" },
            "Downregulated": { x: [], y: [], text: [], color: "#1f78b4" },
            "Not Significant": { x: [], y: [], text: [], color: "#8c9a91" },
          };

          for (const p of points) {
            const g = groups[p.group] || groups["Not Significant"];
            g.x.push(p.x);
            g.y.push(p.y);
            g.text.push(`${p.gene}<br>log2FC=${p.x.toFixed(3)}<br>-log10(padj)=${p.y.toFixed(3)}`);
          }

          const traces = Object.entries(groups).map(([name, g]) => ({
            x: g.x,
            y: g.y,
            text: g.text,
            mode: "markers",
            type: "scattergl",
            name,
            hovertemplate: "%{text}<extra></extra>",
            marker: { size: 6, color: g.color, opacity: 0.8 }
          }));

          const layout = {
            margin: { l: 50, r: 20, t: 20, b: 50 },
            paper_bgcolor: "#fbfdfb",
            plot_bgcolor: "#fbfdfb",
            xaxis: { title: "log2 Fold Change", zeroline: true, zerolinecolor: "#4d5a52" },
            yaxis: { title: "-log10 adjusted p-value", zeroline: false },
            legend: { orientation: "h", y: 1.1 }
          };

          Plotly.newPlot("volcano-plot", traces, layout, { responsive: true, displaylogo: false });
        })();
      </script>
    {% endif %}
  </body>
</html>
